<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單字卡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans', 'Noto Sans TC', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .flip-card {
            perspective: 1000px;
        }
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            border-radius: 1.5rem;
        }
        .flip-card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }
        .noselect {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .correct {
            color: green;
            font-weight: bold;
        }
        .incorrect {
            color: red;
            font-weight: bold;
        }
        /* 專門處理音標的字體 */
        .phonetics-font {
            font-family: 'Noto Sans', sans-serif;
        }
        /* 讓按鈕有被按下的感覺 */
        .btn-active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2) inset;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl mx-auto p-4 md:p-8">
        <!-- 導覽標籤 -->
        <div class="flex border-b mb-6">
            <button id="flashcardTab" class="py-2 px-4 text-lg font-semibold transition-colors duration-200">單字卡</button>
            <button id="dictationTab" class="py-2 px-4 text-lg font-semibold transition-colors duration-200">聽寫</button>
            <button class="text-gray-500 py-2 px-4 text-lg font-semibold transition-colors duration-200">文章聽寫</button>
        </div>

        <!-- 單字卡頁面 -->
        <div id="flashcardPage" class="space-y-6">
            <!-- 進度顯示 -->
            <div id="progress" class="text-center text-gray-500 text-lg">0 / 0</div>

            <!-- ===== 修改: 類別選擇 ===== -->
            <div class="flex justify-center items-center mb-4 space-x-2">
                <label class="text-gray-700 font-semibold mr-2">類別:</label>
                <button data-category="U1" class="category-btn font-bold py-2 px-4 rounded-lg shadow transition-transform transform">U1</button>
                <button data-category="U2" class="category-btn font-bold py-2 px-4 rounded-lg shadow transition-transform transform">U2</button>
                <button data-category="U3" class="category-btn font-bold py-2 px-4 rounded-lg shadow transition-transform transform">U3</button>
            </div>

            <!-- 發音速度選擇 -->
            <div class="flex justify-center items-center mb-4">
                <label for="flashcardSpeechRateSelect" class="text-gray-700 font-semibold mr-2">發音速度:</label>
                <select id="flashcardSpeechRateSelect" class="p-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="1.0">正常速度</option>
                    <option value="0.7">0.7 倍</option>
                    <option value="0.5">0.5 倍</option>
                </select>
            </div>
            
            <!-- 卡片容器 -->
            <div id="flashcard" class="flip-card w-full h-80 md:h-96 rounded-3xl cursor-pointer noselect">
                <div id="flashcard-inner" class="flip-card-inner shadow-lg rounded-3xl">
                    <!-- 卡片正面 (英文) -->
                    <div class="flip-card-front bg-gradient-to-br from-blue-100 via-purple-100 to-blue-200">
                        <h2 id="word" class="text-4xl md:text-6xl font-bold text-gray-800 text-center"></h2>
                        <div class="flex flex-col items-center justify-center mb-2">
                            <p id="partOfSpeech" class="text-xl text-gray-700"></p>
                            <p id="phonetics" class="text-2xl text-gray-600 mt-1 phonetics-font"></p>
                        </div>
                        <!-- 句子結構標示 -->
                        <div id="sentenceAnalysis" class="flex flex-wrap justify-center items-center gap-2 mt-2 text-lg md:text-xl"></div>
                        
                        <!-- 單字發音按鈕 -->
                        <button id="speakBtn" class="absolute bottom-6 right-6 p-3 rounded-full bg-white/50 hover:bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                        </button>
                        <!-- 句子發音按鈕 -->
                        <button id="speakSentenceBtn" class="absolute bottom-6 left-6 p-3 font-semibold text-lg text-blue-600 rounded-full bg-white/50 hover:bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                            sentence
                        </button>
                    </div>
                    <!-- 卡片反面 (中文) -->
                    <div class="flip-card-back">
                        <h2 id="definition" class="text-3xl md:text-5xl font-bold text-white text-center"></h2>
                        <p id="sentence-translation" class="mt-4 text-xl md:text-2xl text-white text-center px-4"></p>
                    </div>
                </div>
            </div>

            <!-- 控制按鈕 -->
            <div class="flex justify-center items-center gap-4">
                <button id="prevBtn" class="bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-lg shadow hover:bg-gray-300 transition-colors">上一個</button>
                <button id="nextBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-blue-600 transition-colors">下一個</button>
                <button id="continuousBtn" class="bg-purple-500 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-purple-600 transition-colors">連續</button>
            </div>
        </div>

        <!-- 聽寫頁面 -->
        <div id="dictationPage" class="space-y-6 hidden text-center">
            <div id="dictationProgress" class="text-center text-gray-500 text-lg"></div>
            <p class="text-2xl font-bold text-gray-700 mt-8">請聽發音並拼出單字：</p>
            
            <div class="flex flex-col items-center justify-center h-48">
                <!-- ===== 修改: 類別選擇 ===== -->
                <div class="flex justify-center items-center mb-4 space-x-2">
                    <label class="text-gray-700 font-semibold mr-2">類別:</label>
                    <button data-category="U1" class="category-btn font-bold py-2 px-4 rounded-lg shadow transition-transform transform">U1</button>
                    <button data-category="U2" class="category-btn font-bold py-2 px-4 rounded-lg shadow transition-transform transform">U2</button>
                    <button data-category="U3" class="category-btn font-bold py-2 px-4 rounded-lg shadow transition-transform transform">U3</button>
                </div>
                <!-- 發音速度選擇 -->
                <div class="mb-4">
                    <label for="dictationSpeechRateSelect" class="text-gray-700 font-semibold mr-2">發音速度:</label>
                    <select id="dictationSpeechRateSelect" class="p-2 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1.0">正常速度</option>
                        <option value="0.7">0.7 倍</option>
                        <option value="0.5">0.5 倍</option>
                    </select>
                </div>
                <!-- 發音按鈕 -->
                <button id="dictationSpeakBtn" class="p-8 rounded-full bg-blue-500 text-white shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mt-8 px-4">
                <input id="answerInput" type="text" placeholder="在此輸入答案" class="w-full max-w-lg p-4 text-center text-xl rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </div>

            <div id="resultMessage" class="mt-4 text-2xl font-bold"></div>

            <div class="flex justify-center items-center gap-4 mt-6">
                <button id="checkBtn" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-blue-600 transition-colors">檢查</button>
                <button id="nextDictationBtn" class="bg-gray-200 text-gray-700 font-bold py-3 px-8 rounded-lg shadow hover:bg-gray-300 transition-colors">下一題</button>
            </div>
        </div>
    </div>

    <script>
        const wordCategories = {
            'U1': [
                { english: 'handsome', partOfSpeech: 'adj.', phonetics: "[ˈhænsəm]", sentence: "Your father is handsome.", chinese: '英俊的', chineseSentence: '你的父親很英俊。', sentenceAnalysis: [{ text: 'Your father', type: 'S' }, { text: 'is', type: 'V' }, { text: 'handsome', type: 'C' }] },
                { english: 'new', partOfSpeech: 'adj.', phonetics: "[njuː]", sentence: "Is this your new school bag?", chinese: '新的', chineseSentence: '這是你的新書包嗎？', sentenceAnalysis: [{ text: 'Is', type: 'V' }, { text: 'this', type: 'S' }, { text: 'your new school bag?', type: 'C' }] },
                { english: 'classmate', partOfSpeech: 'n.', phonetics: "[ˈklæsmeɪt]", sentence: "She's my classmate.", chinese: '同學', chineseSentence: '她是我同學。', sentenceAnalysis: [{ text: "She's", type: 'S+V' }, { text: 'my classmate', type: 'C' }] },
                { english: 'young', partOfSpeech: 'adj.', phonetics: "[jʌŋ]", sentence: "He's young.", chinese: '年輕的', chineseSentence: '他很年輕。', sentenceAnalysis: [{ text: "He's", type: 'S+V' }, { text: 'young', type: 'C' }] },
                { english: 'woman', partOfSpeech: 'n.', phonetics: "[ˈwʊmən]", sentence: "Who's that beautiful tall woman?", chinese: '女人', chineseSentence: '那個美麗高挑的女人是誰？', sentenceAnalysis: [{ text: "Who's", type: 'Q+V' }, { text: 'that beautiful tall woman?', type: 'S' }] },
                { english: 'very', partOfSpeech: 'adv.', phonetics: "[ˈveri]", sentence: "This tree is very tall.", chinese: '非常', chineseSentence: '這棵樹非常高。', sentenceAnalysis: [{ text: 'This tree', type: 'S' }, { text: 'is', type: 'V' }, { text: 'very tall', type: 'C' }] },
                { english: 'beautiful', partOfSpeech: 'adj.', phonetics: "[ˈbjuːtɪfl]", sentence: "Your school is big and beautiful.", chinese: '美麗的', chineseSentence: '你的學校又大又漂亮。', sentenceAnalysis: [{ text: 'Your school', type: 'S' }, { text: 'is', type: 'V' }, { text: 'big and beautiful', type: 'C' }] },
                { english: 'too', partOfSpeech: 'adv.', phonetics: "[tuː]", sentence: "My dad is a teacher, too.", chinese: '也', chineseSentence: '我爸爸也是老師。', sentenceAnalysis: [{ text: 'My dad', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a teacher, too', type: 'C' }] },
                { english: 'Nice to meet you.', partOfSpeech: '', phonetics: "[naɪs tu mit ju]", sentence: "Nice to meet you, Mr. Brown.", chinese: '很高興認識你', chineseSentence: '很高興認識你，布朗先生。', sentenceAnalysis: [] },
                { english: 'cousin', partOfSpeech: 'n.', phonetics: "[ˈkʌzn]", sentence: "Sharon is my cousin, not my sister.", chinese: '堂表兄弟姊妹', chineseSentence: '雪倫是我的堂姊，不是我姊姊。', sentenceAnalysis: [{ text: 'Sharon', type: 'S' }, { text: 'is', type: 'V' }, { text: 'my cousin, not my sister', type: 'C' }] },
                { english: 'really', partOfSpeech: 'adv.', phonetics: "[ˈriːəli]", sentence: "Oh, really? I am, too.", chinese: '真地', chineseSentence: '哦，真的嗎？我也是。', sentenceAnalysis: [] },
                { english: 'year(s) old', partOfSpeech: '', phonetics: "[jɪr(z) oʊld]", sentence: "Her son is 17 years old.", chinese: '...歲', chineseSentence: '她的兒子17歲。', sentenceAnalysis: [{ text: 'Her son', type: 'S' }, { text: 'is', type: 'V' }, { text: '17 years old', type: 'C' }] },
                { english: 'I see.', partOfSpeech: '', phonetics: "[aɪ siː]", sentence: "I see.", chinese: '我知道了', chineseSentence: '我知道了。', sentenceAnalysis: [{ text: 'I', type: 'S' }, { text: 'see', type: 'V' }] },
                { english: 'singer', partOfSpeech: 'n.', phonetics: "[ˈsɪŋər]", sentence: "He's a singer.", chinese: '歌手', chineseSentence: '他是個歌手。', sentenceAnalysis: [{ text: "He's", type: 'S+V' }, { text: 'a singer', type: 'C' }] },
                { english: 'office worker', partOfSpeech: 'n.', phonetics: "[ˈɔːfɪs ˈwɜːrkər]", sentence: "I am an office worker, and my wife is, too.", chinese: '上班族', chineseSentence: '我是上班族，我太太也是。', sentenceAnalysis: [{ text: 'I', type: 'S' }, { text: 'am', type: 'V' }, { text: 'an office worker', type: 'C' }] },
                { english: 'housewife', partOfSpeech: 'n.', phonetics: "[ˈhaʊswaɪf]", sentence: "My grandmother is a housewife.", chinese: '家庭主婦', chineseSentence: '我的祖母是家庭主婦。', sentenceAnalysis: [{ text: 'My grandmother', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a housewife', type: 'C' }] },
                { english: 'police officer', partOfSpeech: 'n.', phonetics: "[pəˈliːs ˈɔːfɪsər]", sentence: "He is a police officer.", chinese: '警察', chineseSentence: '他是警察。', sentenceAnalysis: [{ text: 'He', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a police officer', type: 'C' }] },
                { english: 'writer', partOfSpeech: 'n.', phonetics: "[ˈraɪtər]", sentence: "Are you a writer?", chinese: '作家', chineseSentence: '你是作家嗎？', sentenceAnalysis: [{ text: 'Are', type: 'V' }, { text: 'you', type: 'S' }, { text: 'a writer?', type: 'C' }] },
                { english: 'uncle', partOfSpeech: 'n.', phonetics: "[ˈʌŋkl]", sentence: "My uncle is a good cook.", chinese: '叔伯；舅舅', chineseSentence: '我叔叔很會做菜。', sentenceAnalysis: [{ text: 'My uncle', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a good cook', type: 'C' }] },
                { english: 'aunt', partOfSpeech: 'n.', phonetics: "[ænt]", sentence: "Aunt Shelly is my mother's good friend.", chinese: '阿姨；姑姑', chineseSentence: '雪莉阿姨是我媽媽的好朋友。', sentenceAnalysis: [{ text: 'Aunt Shelly', type: 'S' }, { text: 'is', type: 'V' }, { text: "my mother's good friend", type: 'C' }] },
                { english: 'wife', partOfSpeech: 'n.', phonetics: "[waɪf]", sentence: "Isn't his wife a doctor?", chinese: '妻子', chineseSentence: '他太太不是醫生嗎？', sentenceAnalysis: [{ text: "Isn't", type: 'V' }, { text: 'his wife', type: 'S' }, { text: 'a doctor?', type: 'C' }] },
                { english: 'daughter', partOfSpeech: 'n.', phonetics: "[ˈdɔːtər]", sentence: "Julia is Mr. and Mrs. Wilson's daughter.", chinese: '女兒', chineseSentence: '茱莉亞是威爾森夫婦的女兒。', sentenceAnalysis: [{ text: 'Julia', type: 'S' }, { text: 'is', type: 'V' }, { text: "Mr. and Mrs. Wilson's daughter", type: 'C' }] },
                { english: 'husband', partOfSpeech: 'n.', phonetics: "[ˈhʌzbənd]", sentence: "Her husband is a nurse.", chinese: '丈夫', chineseSentence: '她丈夫是護士。', sentenceAnalysis: [{ text: 'Her husband', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a nurse', type: 'C' }] },
                { english: 'son', partOfSpeech: 'n.', phonetics: "[sʌn]", sentence: "Mrs. Fang is a mother of three sons.", chinese: '兒子', chineseSentence: '方太太是三個兒子的媽媽。', sentenceAnalysis: [{ text: 'Mrs. Fang', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a mother of three sons', type: 'C' }] },
                { english: 'dear', partOfSpeech: 'adj.', phonetics: "[dɪr]", sentence: "This is a picture of my dear students.", chinese: '親愛的', chineseSentence: '這是我親愛學生的照片。', sentenceAnalysis: [{ text: 'This', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a picture of my dear students', type: 'C' }] },
                { english: 'family', partOfSpeech: 'n.', phonetics: "[ˈfæməli]", sentence: "How's your family?", chinese: '家庭；家人', chineseSentence: '你家人好嗎？', sentenceAnalysis: [{ text: "How's", type: 'Q+V' }, { text: 'your family?', type: 'S' }] },
                { english: 'elementary school', partOfSpeech: 'n.', phonetics: "[ˌeləˈmentri skuːl]", sentence: "She is an elementary school student.", chinese: '國小', chineseSentence: '她是國小生。', sentenceAnalysis: [{ text: 'She', type: 'S' }, { text: 'is', type: 'V' }, { text: 'an elementary school student', type: 'C' }] },
                { english: 'junior high school', partOfSpeech: 'n.', phonetics: "[ˈdʒuːnjər haɪ skuːl]", sentence: "My mom is a junior high school teacher.", chinese: '國中', chineseSentence: '我媽媽是國中老師。', sentenceAnalysis: [{ text: 'My mom', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a junior high school teacher', type: 'C' }] },
                { english: 'baby', partOfSpeech: 'n.; adj.', phonetics: "[ˈbeɪbi]", sentence: "The baby's father is Mr. Martin.", chinese: '嬰兒；年幼的', chineseSentence: '這嬰兒的父親是馬丁先生。', sentenceAnalysis: [{ text: "The baby's father", type: 'S' }, { text: 'is', type: 'V' }, { text: 'Mr. Martin', type: 'C' }] }
            ],
            'U2': [
                { english: 'house', partOfSpeech: 'n.', phonetics: "[haʊs]", sentence: "Jimmy is not in the house.", chinese: '房子', chineseSentence: '吉米不在家裡。', sentenceAnalysis: [{ text: 'Jimmy', type: 'S' }, { text: 'is not', type: 'V' }, { text: 'in the house', type: 'A' }] },
                { english: 'parents', partOfSpeech: 'n.', phonetics: "[ˈperənts]", sentence: "Her parents are very nice.", chinese: '父母親', chineseSentence: '她的父母很和藹。', sentenceAnalysis: [{ text: 'Her parents', type: 'S' }, { text: 'are', type: 'V' }, { text: 'very nice', type: 'C' }] },
                { english: 'living room', partOfSpeech: 'n.', phonetics: "[ˈlɪvɪŋ ruːm]", sentence: "The new sofa is in the living room.", chinese: '客廳', chineseSentence: '新沙發在客廳裡。', sentenceAnalysis: [{ text: 'The new sofa', type: 'S' }, { text: 'is', type: 'V' }, { text: 'in the living room', type: 'A' }] },
                { english: 'wall', partOfSpeech: 'n.', phonetics: "[wɔːl]", sentence: "The walls of this room are thin.", chinese: '牆壁', chineseSentence: '這個房間的牆壁很薄。', sentenceAnalysis: [{ text: 'The walls of this room', type: 'S' }, { text: 'are', type: 'V' }, { text: 'thin', type: 'C' }] },
                { english: 'purple', partOfSpeech: 'adj.;n.', phonetics: "[ˈpɜːrpl]", sentence: "The singer's hair is purple.", chinese: '紫色的', chineseSentence: '這位歌手的頭髮是紫色的。', sentenceAnalysis: [{ text: "The singer's hair", type: 'S' }, { text: 'is', type: 'V' }, { text: 'purple', type: 'C' }] },
                { english: 'favorite', partOfSpeech: 'adj.;n.', phonetics: "[ˈfeɪvərɪt]", sentence: "This is my favorite park. It's nice and big.", chinese: '最喜愛的', chineseSentence: '這是我最喜歡的公園。它又好又大。', sentenceAnalysis: [{ text: 'This', type: 'S' }, { text: 'is', type: 'V' }, { text: 'my favorite park', type: 'C' }] },
                { english: 'color', partOfSpeech: 'n.', phonetics: "[ˈkʌlər]", sentence: "My favorite color is blue.", chinese: '顏色', chineseSentence: '我最喜歡的顏色是藍色。', sentenceAnalysis: [{ text: 'My favorite color', type: 'S' }, { text: 'is', type: 'V' }, { text: 'blue', type: 'C' }] },
                { english: 'kitchen', partOfSpeech: 'n.', phonetics: "[ˈkɪtʃɪn]", sentence: "Is your aunt in the kitchen?", chinese: '廚房', chineseSentence: '你的阿姨在廚房嗎？', sentenceAnalysis: [{ text: 'Is', type: 'V' }, { text: 'your aunt', type: 'S' }, { text: 'in the kitchen?', type: 'A' }] },
                { english: 'dining room', partOfSpeech: 'n.', phonetics: "[ˈdaɪnɪŋ ruːm]", sentence: "Aren't the eggs on the dining room table?", chinese: '飯廳', chineseSentence: '雞蛋不是在飯廳的餐桌上嗎?', sentenceAnalysis: [{ text: "Aren't", type: 'V' }, { text: 'the eggs', type: 'S' }, { text: 'on the dining room table?', type: 'A' }] },
                { english: 'but', partOfSpeech: 'conj.', phonetics: "[bʌt]", sentence: "My room is big, but my bed is not.", chinese: '但是', chineseSentence: '我的房間很大，但是我的床不是。', sentenceAnalysis: [{ text: 'My room is big', type: 'Clause' }, { text: ', but', type: 'Conj' }, { text: 'my bed is not', type: 'Clause' }] },
                { english: 'gray', partOfSpeech: 'adj.;n.', phonetics: "[ɡreɪ]", sentence: "My dad's car is gray.", chinese: '灰色的', chineseSentence: '我爸爸的車是灰色的。', sentenceAnalysis: [{ text: "My dad's car", type: 'S' }, { text: 'is', type: 'V' }, { text: 'gray', type: 'C' }] },
                { english: 'brown', partOfSpeech: 'adj.;n.', phonetics: "[braʊn]", sentence: "Jerry's dog is brown.", chinese: '棕色的', chineseSentence: '傑瑞的狗是棕色的。', sentenceAnalysis: [{ text: "Jerry's dog", type: 'S' }, { text: 'is', type: 'V' }, { text: 'brown', type: 'C' }] },
                { english: 'cookie', partOfSpeech: 'n.', phonetics: "[ˈkʊki]", sentence: "They are cookies for my mom.", chinese: '餅乾', chineseSentence: '它們是我媽媽的餅乾。', sentenceAnalysis: [{ text: 'They', type: 'S' }, { text: 'are', type: 'V' }, { text: 'cookies for my mom', type: 'C' }] },
                { english: 'mice', partOfSpeech: 'n.', phonetics: "[maɪs]", sentence: "Two white mice are in the box.", chinese: '老鼠(複數)', chineseSentence: '箱子裡有兩隻白老鼠。', sentenceAnalysis: [{ text: 'Two white mice', type: 'S' }, { text: 'are', type: 'V' }, { text: 'in the box', type: 'A' }] },
                { english: 'maybe', partOfSpeech: 'adv.', phonetics: "[ˈmeɪbi]", sentence: "Maybe he's in his dog house.", chinese: '可能', chineseSentence: '也許他在他的狗屋裡。', sentenceAnalysis: [{ text: 'Maybe', type: 'Adv' }, { text: "he's", type: 'S+V' }, { text: 'in his dog house', type: 'A' }] },
                { english: 'sofa', partOfSpeech: 'n.', phonetics: "[ˈsoʊfə]", sentence: "The old sofa is in my grandfather's bedroom.", chinese: '沙發', chineseSentence: '舊沙發在我爺爺的臥室裡。', sentenceAnalysis: [{ text: 'The old sofa', type: 'S' }, { text: 'is', type: 'V' }, { text: "in my grandfather's bedroom", type: 'A' }] },
                { english: 'hungry', partOfSpeech: 'adj.', phonetics: "[ˈhʌŋɡri]", sentence: "I'm hungry.", chinese: '餓的', chineseSentence: '我餓了。', sentenceAnalysis: [{ text: "I'm", type: 'S+V' }, { text: 'hungry', type: 'C' }] },
                { english: 'notebook', partOfSpeech: 'n.', phonetics: "[ˈnoʊtbʊk]", sentence: "My notebooks are in my schoolbag.", chinese: '筆記本', chineseSentence: '我的筆記本在我的書包裡。', sentenceAnalysis: [{ text: 'My notebooks', type: 'S' }, { text: 'are', type: 'V' }, { text: 'in my schoolbag', type: 'A' }] },
                { english: 'marker', partOfSpeech: 'n.', phonetics: "[ˈmɑːrkər]", sentence: "It's under your desk.", chinese: '彩色筆', chineseSentence: '它在你的書桌底下。', sentenceAnalysis: [{ text: "It's", type: 'S+V' }, { text: 'under your desk', type: 'A' }] },
                { english: 'brush', partOfSpeech: 'n.', phonetics: "[brʌʃ]", sentence: "Your brush is under your bed.", chinese: '毛筆;刷子', chineseSentence: '你的毛筆在你的床底下。', sentenceAnalysis: [{ text: 'Your brush', type: 'S' }, { text: 'is', type: 'V' }, { text: 'under your bed', type: 'A' }] },
                { english: 'gift', partOfSpeech: 'n.', phonetics: "[ɡɪft]", sentence: "It's a gift for you.", chinese: '禮物', chineseSentence: '這是給你的禮物。', sentenceAnalysis: [{ text: "It's", type: 'S+V' }, { text: 'a gift for you', type: 'C' }] },
                { english: 'pencil case', partOfSpeech: 'n.', phonetics: "[ˈpensl kes]", sentence: "My pencil case is on the desk.", chinese: '鉛筆盒', chineseSentence: '我的鉛筆盒在書桌上。', sentenceAnalysis: [{ text: 'My pencil case', type: 'S' }, { text: 'is', type: 'V' }, { text: 'on the desk', type: 'A' }] },
                { english: 'bathroom', partOfSpeech: 'n.', phonetics: "[ˈbæθruːm]", sentence: "Are you in the bathroom, Mom?", chinese: '浴室;廁所', chineseSentence: '媽，你在浴室嗎？', sentenceAnalysis: [{ text: 'Are', type: 'V' }, { text: 'you', type: 'S' }, { text: 'in the bathroom, Mom?', type: 'A' }] },
                { english: 'table', partOfSpeech: 'n.', phonetics: "[ˈteɪbl]", sentence: "Sammy, your pencil is on the table.", chinese: '桌子', chineseSentence: '山米，你的鉛筆在桌子上。', sentenceAnalysis: [{ text: 'your pencil', type: 'S' }, { text: 'is', type: 'V' }, { text: 'on the table', type: 'A' }] },
                { english: 'bedroom', partOfSpeech: 'n.', phonetics: "[ˈbedruːm]", sentence: "Her bedroom is next to the living room.", chinese: '臥室', chineseSentence: '她的臥室在客廳旁邊。', sentenceAnalysis: [{ text: 'Her bedroom', type: 'S' }, { text: 'is', type: 'V' }, { text: 'next to the living room', type: 'A' }] },
                { english: 'near', partOfSpeech: 'prep.', phonetics: "[nɪr]", sentence: "My uncle's farm is near the zoo.", chinese: '在…附近', chineseSentence: '我叔叔的農場在動物園附近。', sentenceAnalysis: [{ text: "My uncle's farm", type: 'S' }, { text: 'is', type: 'V' }, { text: 'near the zoo', type: 'A' }] },
                { english: 'between', partOfSpeech: 'prep.', phonetics: "[bɪˈtwiːn]", sentence: "She's my sister, Nina.", chinese: '在…之間', chineseSentence: '她是我妹妹，妮娜。', sentenceAnalysis: [{ text: "She's", type: 'S+V' }, { text: 'my sister, Nina', type: 'C' }] },
                { english: 'behind', partOfSpeech: 'prep.', phonetics: "[bɪˈhaɪnd]", sentence: "Kenny's cat is behind the tree.", chinese: '在…後面', chineseSentence: '肯尼的貓在樹後面。', sentenceAnalysis: [{ text: "Kenny's cat", type: 'S' }, { text: 'is', type: 'V' }, { text: 'behind the tree', type: 'A' }] },
                { english: 'in front of', partOfSpeech: 'prep.', phonetics: "[ɪn frʌnt əv]", sentence: "The old tree is in front of our school.", chinese: '在…前面', chineseSentence: '那棵老樹在我們學校前面。', sentenceAnalysis: [{ text: 'The old tree', type: 'S' }, { text: 'is', type: 'V' }, { text: 'in front of our school', type: 'A' }] },
                { english: 'special', partOfSpeech: 'adj.', phonetics: "[ˈspeʃl]", sentence: "What's special about this pencil?", chinese: '特別的', chineseSentence: '這支鉛筆有什麼特別的？', sentenceAnalysis: [{ text: "What's", type: 'Q+V' }, { text: 'special', type: 'C' }, { text: 'about this pencil?', type: 'A' }] },
                { english: 'inside', partOfSpeech: 'prep.', phonetics: "[ɪnˈsaɪd]", sentence: "They're apples from your grandma.", chinese: '在…裡面', chineseSentence: '它們是你奶奶給的蘋果。', sentenceAnalysis: [{ text: "They're", type: 'S+V' }, { text: 'apples from your grandma', type: 'C' }] },
                { english: 'right', partOfSpeech: 'adv.', phonetics: "[raɪt]", sentence: "My house is right next to a park.", chinese: '就', chineseSentence: '我家就在公園旁邊。', sentenceAnalysis: [{ text: 'My house', type: 'S' }, { text: 'is', type: 'V' }, { text: 'right next to a park', type: 'A' }] },
                { english: 'each other', partOfSpeech: 'pron.', phonetics: "[ˌiːtʃ ˈʌðər]", sentence: "My classmates are nice to each other.", chinese: '彼此;互相', chineseSentence: '我的同學們對彼此都很好。', sentenceAnalysis: [{ text: 'My classmates', type: 'S' }, { text: 'are', type: 'V' }, { text: 'nice', type: 'C' }, { text: 'to each other', type: 'A' }] },
                { english: 'above', partOfSpeech: 'prep.;adv.', phonetics: "[əˈbʌv]", sentence: "The clock is above the TV.", chinese: '在…上方', chineseSentence: '時鐘在電視上方。', sentenceAnalysis: [{ text: 'The clock', type: 'S' }, { text: 'is', type: 'V' }, { text: 'above the TV', type: 'A' }] },
                { english: 'enough', partOfSpeech: 'adj.;adv.;pron.', phonetics: "[ɪˈnʌf]", sentence: "The dining table is not very big, but it's enough for a family of three.", chinese: '足夠(的)', chineseSentence: '餐桌不是很大，但對一個三口之家來說夠用了。', sentenceAnalysis: [{ text: "it's", type: 'S+V' }, { text: 'enough for a family of three', type: 'C' }] },
                { english: 'person', partOfSpeech: 'n.', phonetics: "[ˈpɜːrsn]", sentence: "Jeremy is a nice person.", chinese: '人', chineseSentence: '傑瑞米是個好人。', sentenceAnalysis: [{ text: 'Jeremy', type: 'S' }, { text: 'is', type: 'V' }, { text: 'a nice person', type: 'C' }] }
            ],
            'U3': []
        };

        let currentCategory = 'U1';
        let currentIndex = 0;
        let currentDictationWordIndex;
        let isReadingContinuously = false;

        // Flashcard elements
        const flashcardTab = document.getElementById('flashcardTab');
        const flashcardPage = document.getElementById('flashcardPage');
        const flashcard = document.getElementById('flashcard');
        const wordEl = document.getElementById('word');
        const partOfSpeechEl = document.getElementById('partOfSpeech');
        const phoneticsEl = document.getElementById('phonetics');
        const sentenceAnalysisEl = document.getElementById('sentenceAnalysis');
        const definitionEl = document.getElementById('definition');
        const sentenceTranslationEl = document.getElementById('sentence-translation');
        const progressEl = document.getElementById('progress');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const continuousBtn = document.getElementById('continuousBtn');
        const speakBtn = document.getElementById('speakBtn');
        const speakSentenceBtn = document.getElementById('speakSentenceBtn');
        const flashcardSpeechRateSelect = document.getElementById('flashcardSpeechRateSelect');

        // Dictation elements
        const dictationTab = document.getElementById('dictationTab');
        const dictationPage = document.getElementById('dictationPage');
        const dictationProgress = document.getElementById('dictationProgress');
        const dictationSpeakBtn = document.getElementById('dictationSpeakBtn');
        const answerInput = document.getElementById('answerInput');
        const resultMessage = document.getElementById('resultMessage');
        const checkBtn = document.getElementById('checkBtn');
        const nextDictationBtn = document.getElementById('nextDictationBtn');
        const dictationSpeechRateSelect = document.getElementById('dictationSpeechRateSelect');
        
        // Category elements
        const categoryButtons = document.querySelectorAll('.category-btn');
        
        // 目前作用中的單字列表
        let activeWords = wordCategories[currentCategory];

        // Function to speak the word or sentence
        function speak(text, rate = 1.0) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = rate;
                window.speechSynthesis.speak(utterance);
            } else {
                console.log('抱歉，您的瀏覽器不支援語音合成功能。');
            }
        }
        
        // --- 類別切換邏輯 ---
        function updateCategoryButtonsUI(activeCategory) {
            categoryButtons.forEach(btn => {
                if (btn.dataset.category === activeCategory) {
                    btn.classList.remove('bg-gray-300', 'text-gray-700');
                    btn.classList.add('bg-blue-500', 'text-white');
                } else {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-300', 'text-gray-700');
                }
            });
        }

        function changeCategory(newCategory) {
            if (currentCategory === newCategory) return;

            currentCategory = newCategory;
            activeWords = wordCategories[currentCategory];
            currentIndex = 0;
            
            updateCategoryButtonsUI(currentCategory);

            if (!flashcardPage.classList.contains('hidden')) {
                updateCard(currentIndex);
            }
            if (!dictationPage.classList.contains('hidden')) {
                startDictation();
            }
        }
        
        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                changeCategory(btn.dataset.category);
            });
        });


        // --- 單字卡頁面邏輯 ---
        function updateCard(index) {
            if (activeWords.length === 0) {
                 wordEl.textContent = '請新增單字';
                 partOfSpeechEl.textContent = '';
                 phoneticsEl.textContent = '';
                 definitionEl.textContent = '此類別無單字';
                 sentenceTranslationEl.textContent = '';
                 progressEl.textContent = '0 / 0';
                 sentenceAnalysisEl.innerHTML = '';
                 flashcard.classList.remove('flipped');
                 return;
            }
            currentIndex = index;
            const currentWord = activeWords[currentIndex];
            wordEl.textContent = currentWord.english;
            partOfSpeechEl.textContent = currentWord.partOfSpeech;
            phoneticsEl.textContent = currentWord.phonetics;
            definitionEl.textContent = currentWord.chinese;
            sentenceTranslationEl.textContent = currentWord.chineseSentence;
            progressEl.textContent = `${currentIndex + 1} / ${activeWords.length}`;
            flashcard.classList.remove('flipped');
            
            updateSentenceAnalysis(currentWord.sentenceAnalysis);
        }

        function updateSentenceAnalysis(analysisData) {
            sentenceAnalysisEl.innerHTML = ''; 
            if (!analysisData) return;
            analysisData.forEach(item => {
                const wordContainer = document.createElement('div');
                wordContainer.className = 'flex flex-col items-center';
                
                const wordSpan = document.createElement('span');
                wordSpan.textContent = item.text;
                if (item.type === 'V') {
                    wordSpan.classList.add('text-red-500', 'font-bold');
                }
                
                const typeSpan = document.createElement('span');
                typeSpan.textContent = `(${item.type})`;
                typeSpan.classList.add('text-xs', 'text-gray-500');

                wordContainer.appendChild(wordSpan);
                wordContainer.appendChild(typeSpan);
                sentenceAnalysisEl.appendChild(wordContainer);
            });
        }

        flashcard.addEventListener('click', (event) => {
            if (event.target.closest('button')) return;
            if (activeWords.length === 0) return;
            if (!isReadingContinuously) {
                flashcard.classList.toggle('flipped');
            }
        });

        speakBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (activeWords.length === 0) return;
            const rate = parseFloat(flashcardSpeechRateSelect.value);
            speak(activeWords[currentIndex].english, rate);
        });

        speakSentenceBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (activeWords.length === 0) return;
            const rate = parseFloat(flashcardSpeechRateSelect.value);
            speak(activeWords[currentIndex].sentence, rate);
        });

        nextBtn.addEventListener('click', () => {
            if (activeWords.length === 0) return;
            if (isReadingContinuously) {
                window.speechSynthesis.cancel();
                isReadingContinuously = false;
            }
            currentIndex = (currentIndex + 1) % activeWords.length;
            updateCard(currentIndex);
        });

        prevBtn.addEventListener('click', () => {
            if (activeWords.length === 0) return;
            if (isReadingContinuously) {
                window.speechSynthesis.cancel();
                isReadingContinuously = false;
            }
            currentIndex = (currentIndex - 1 + activeWords.length) % activeWords.length;
            updateCard(currentIndex);
        });

        continuousBtn.addEventListener('click', () => {
            if (activeWords.length === 0) return;
            if (isReadingContinuously) {
                window.speechSynthesis.cancel();
                isReadingContinuously = false;
                continuousBtn.textContent = '連續';
                continuousBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                continuousBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                return;
            }
            
            isReadingContinuously = true;
            continuousBtn.textContent = '停止';
            continuousBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            continuousBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');

            let currentContinuousIndex = currentIndex;
            
            function readWordWithRepetitions(wordIndex, repetition = 0) {
                if (!isReadingContinuously || wordIndex >= activeWords.length) {
                    isReadingContinuously = false;
                    continuousBtn.click();
                    return;
                }
                
                if (repetition < 3) {
                    updateCard(wordIndex);
                    const rate = parseFloat(flashcardSpeechRateSelect.value);
                    const utterance = new SpeechSynthesisUtterance(activeWords[wordIndex].english);
                    utterance.lang = 'en-US';
                    utterance.rate = rate;
                    utterance.onend = () => {
                        if (isReadingContinuously) {
                            setTimeout(() => readWordWithRepetitions(wordIndex, repetition + 1), 200);
                        }
                    };
                    window.speechSynthesis.speak(utterance);
                } else {
                    currentContinuousIndex++;
                    if (currentContinuousIndex < activeWords.length) {
                        setTimeout(() => {
                            readWordWithRepetitions(currentContinuousIndex, 0);
                        }, 1000);
                    } else {
                        isReadingContinuously = false;
                        continuousBtn.click();
                    }
                }
            }
            readWordWithRepetitions(currentContinuousIndex, 0);
        });

        // --- 聽寫頁面邏輯 ---
        function startDictation() {
            if (activeWords.length === 0) {
                 answerInput.value = '';
                 answerInput.disabled = true;
                 resultMessage.textContent = '此類別無單字可供聽寫';
                 dictationProgress.textContent = '0 個單字';
                 return;
            }
            answerInput.disabled = false;
            currentDictationWordIndex = Math.floor(Math.random() * activeWords.length);
            answerInput.value = '';
            resultMessage.textContent = '';
            checkBtn.classList.remove('hidden');
            dictationProgress.textContent = `${activeWords.length} 個單字隨機抽考`;
        }

        dictationSpeakBtn.addEventListener('click', () => {
            if (activeWords.length === 0) return;
            const rate = parseFloat(dictationSpeechRateSelect.value);
            speak(activeWords[currentDictationWordIndex].english, rate);
        });

        checkBtn.addEventListener('click', () => {
            if (activeWords.length === 0) return;
            const userAnswer = answerInput.value.trim().toLowerCase();
            const correctAnswer = activeWords[currentDictationWordIndex].english.toLowerCase();

            if (userAnswer === correctAnswer) {
                resultMessage.textContent = '答對了！';
                resultMessage.className = 'mt-4 text-2xl font-bold correct';
                answerInput.disabled = true;
            } else {
                resultMessage.textContent = `答錯了，正確答案是：${activeWords[currentDictationWordIndex].english}`;
                resultMessage.className = 'mt-4 text-2xl font-bold incorrect';
            }
        });

        nextDictationBtn.addEventListener('click', () => {
            startDictation();
        });
        
        answerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkBtn.click();
            }
        });

        // --- 頁面切換邏輯 ---
        function showPage(pageId) {
            flashcardPage.classList.add('hidden');
            dictationPage.classList.add('hidden');
            flashcardTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            dictationTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            flashcardTab.classList.add('text-gray-500');
            dictationTab.classList.add('text-gray-500');
            
            if (isReadingContinuously) {
                continuousBtn.click();
            }

            if (pageId === 'flashcard') {
                flashcardPage.classList.remove('hidden');
                flashcardTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                flashcardTab.classList.remove('text-gray-500');
                updateCard(currentIndex);
            } else if (pageId === 'dictation') {
                dictationPage.classList.remove('hidden');
                dictationTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                dictationTab.classList.remove('text-gray-500');
                startDictation();
            }
        }

        flashcardTab.addEventListener('click', () => showPage('flashcard'));
        dictationTab.addEventListener('click', () => showPage('dictation'));

        window.onload = () => {
            updateCategoryButtonsUI(currentCategory);
            showPage('flashcard');
        };

    </script>
</body>
</html>
