<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é‡æ§åˆ¶æµç¨‹åœ–æ•™å­¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¢ºä¿ä¸­æ–‡å­—é«”æ¸…æ™° */
        body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
        }
        /* æµç¨‹åœ–ç¯€é»åŸºæœ¬æ¨£å¼ */
        .node-base {
            transition: all 0.3s ease;
            stroke: #333;
            stroke-width: 2px;
        }
        .node-text {
            font-size: 18px;
            font-weight: bold;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none; /* è®“é»æ“Šç©¿é€æ–‡å­—åˆ°åœ–å½¢ä¸Š */
        }
        /* é«˜äº®æ¨£å¼ */
        .active-node {
            fill: #FDE047 !important; /* é»ƒè‰²é«˜äº® */
            stroke: #EAB308 !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 8px rgba(234, 179, 8, 0.6));
        }
        /* éŒ¯èª¤æ™‚çš„éœ‡å‹•å‹•ç•« */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake-node {
            animation: shake 0.3s ease-in-out 2;
        }
        /* éŸ³é‡æ ¼å­æ¨£å¼ */
        .volume-bar {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow-md">
        <h1 class="text-2xl md:text-3xl font-bold text-center">ğŸ”Š éŸ³é‡æ§åˆ¶ç¨‹å¼æµç¨‹åœ–</h1>
    </header>

    <!-- Main Content Container -->
    <main class="flex-grow flex flex-col lg:flex-row p-4 gap-4 items-stretch">

        <!-- Left Side: SVG Flowchart (ä½”å¤§è¢å¹• 2/3) -->
        <div class="lg:w-2/3 bg-white rounded-2xl shadow-lg overflow-hidden border-4 border-indigo-100 p-2 flex justify-center items-start overflow-auto">
            <!-- SVG viewBox è¨­å®šç‚ºé©åˆç¸±å‘æµç¨‹åœ–çš„æ¯”ä¾‹ -->
            <svg id="flowchartSvg" viewBox="0 0 800 1100" class="w-full h-auto max-h-[85vh]" preserveAspectRatio="xMidYMin meet">
                <defs>
                    <!-- å®šç¾©ç®­é ­ -->
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#555" />
                    </marker>
                </defs>

                <!-- é€£æ¥ç·š (Paths) - å…ˆç•«ç·šç¢ºä¿åœ¨ç¯€é»ä¸‹æ–¹ -->
                <g stroke="#555" stroke-width="3" fill="none" marker-end="url(#arrowhead)">
                    <!-- ä¸»å¹¹é“ (å‘ä¸‹) -->
                    <path d="M400,70 V130" /> <!-- Start to P_Minus -->
                    <path d="M400,210 V260" /> <!-- P_Minus to D_200 -->
                    <path d="M400,340 V420" /> <!-- D_200 No to D_150 -->
                    <path d="M400,500 V580" /> <!-- D_150 No to D_100 -->
                    <path d="M400,660 V740" /> <!-- D_100 No to D_50 -->
                    <path d="M400,820 V880" /> <!-- D_50 No to P_1 -->
                    <path d="M400,960 V1020" /> <!-- P_1 to End -->

                    <!-- åˆ†æ”¯ (Yes å‘å³) -->
                    <path d="M480,300 H600" /> <!-- D_200 Yes to P_Full -->
                    <path d="M480,460 H600" /> <!-- D_150 Yes to P_4 -->
                    <path d="M480,620 H600" /> <!-- D_100 Yes to P_3 -->
                    <path d="M480,780 H600" /> <!-- D_50 Yes to P_2 -->

                    <!-- åˆ†æ”¯åŒ¯åˆåˆ°çµæŸ (å¾å³å´å„ç¯€é»å‘ä¸‹åŒ¯åˆ) -->
                    <!-- ç‚ºäº†è®“åœ–å½¢ä¹¾æ·¨ï¼Œæˆ‘å€‘ä½¿ç”¨å–®ç¨çš„çµæŸé»æˆ–åŒ¯åˆç·šã€‚é€™è£¡æ¡ç”¨åŒ¯åˆç·šã€‚ -->
                     <path d="M760,300 H780 V1045 H445" marker-end="none" stroke-dasharray="5,5" opacity="0.3"/> <!-- ç¤ºæ„åŒ¯åˆè·¯å¾‘ -->
                </g>
                <!-- ç‚ºæ¯å€‹åˆ†æ”¯å¢åŠ æ˜ç¢ºçš„ STOP ä»¥ç¬¦åˆåŸå§‹ UML -->
                <g stroke="#555" stroke-width="3" fill="none" marker-end="url(#arrowhead)">
                   <path d="M680,340 V370" /> <path d="M680,500 V530" /> <path d="M680,660 V690" /> <path d="M680,820 V850" />
                </g>


                <!-- Nodes (ç¯€é») -->
                <!-- Start -->
                <g id="node_start" class="node-group" transform="translate(400, 40)">
                    <ellipse cx="0" cy="0" rx="80" ry="30" fill="#86EFAC" class="node-base"/>
                    <text x="0" y="0" class="node-text">é–‹å§‹ (æŒ‰ä¸‹P1)</text>
                </g>

                <!-- Process: éŸ³é‡ - 50 -->
                <g id="node_p_minus" class="node-group" transform="translate(400, 170)">
                    <rect x="-100" y="-40" width="200" height="80" rx="10" fill="#BFDBFE" class="node-base"/>
                    <text x="0" y="0" class="node-text">è¨­å®š éŸ³é‡ = éŸ³é‡ - 50</text>
                </g>

                <!-- Decision: > 200 -->
                <g id="node_d_200" class="node-group" transform="translate(400, 300)">
                    <polygon points="0,-40 80,0 0,40 -80,0" fill="#FDBA74" class="node-base"/>
                    <text x="0" y="0" class="node-text">éŸ³é‡ > 200 ?</text>
                    <text x="90" y="-15" font-size="16" fill="#059669" font-weight="bold">æ˜¯</text>
                    <text x="15" y="60" font-size="16" fill="#DC2626" font-weight="bold">å¦</text>
                </g>

                <!-- Process: æ»¿æ ¼ -->
                <g id="node_p_full" class="node-group" transform="translate(680, 300)">
                    <rect x="-80" y="-40" width="160" height="80" rx="10" fill="#DDD6FE" class="node-base"/>
                    <text x="0" y="0" class="node-text">é¡¯ç¤º æ»¿æ ¼åœ–ç¤º</text>
                </g>
                 <!-- Stop 1 -->
                 <g id="node_stop_1" transform="translate(680, 400)">
                    <circle cx="0" cy="0" r="25" fill="#FCA5A5" class="node-base"/>
                    <text x="0" y="0" font-size="14" class="node-text">çµæŸ</text>
                </g>

                <!-- Decision: > 150 -->
                <g id="node_d_150" class="node-group" transform="translate(400, 460)">
                    <polygon points="0,-40 80,0 0,40 -80,0" fill="#FDBA74" class="node-base"/>
                    <text x="0" y="0" class="node-text">éŸ³é‡ > 150 ?</text>
                    <text x="90" y="-15" font-size="16" fill="#059669" font-weight="bold">æ˜¯</text>
                    <text x="15" y="60" font-size="16" fill="#DC2626" font-weight="bold">å¦</text>
                </g>

                <!-- Process: 4æ ¼ -->
                <g id="node_p_4" class="node-group" transform="translate(680, 460)">
                    <rect x="-80" y="-40" width="160" height="80" rx="10" fill="#DDD6FE" class="node-base"/>
                    <text x="0" y="0" class="node-text">é¡¯ç¤º 4æ ¼åœ–ç¤º</text>
                </g>
                <!-- Stop 2 -->
                <g id="node_stop_2" transform="translate(680, 560)">
                    <circle cx="0" cy="0" r="25" fill="#FCA5A5" class="node-base"/>
                    <text x="0" y="0" font-size="14" class="node-text">çµæŸ</text>
                </g>

                <!-- Decision: > 100 -->
                <g id="node_d_100" class="node-group" transform="translate(400, 620)">
                    <polygon points="0,-40 80,0 0,40 -80,0" fill="#FDBA74" class="node-base"/>
                    <text x="0" y="0" class="node-text">éŸ³é‡ > 100 ?</text>
                    <text x="90" y="-15" font-size="16" fill="#059669" font-weight="bold">æ˜¯</text>
                    <text x="15" y="60" font-size="16" fill="#DC2626" font-weight="bold">å¦</text>
                </g>

                <!-- Process: 3æ ¼ -->
                <g id="node_p_3" class="node-group" transform="translate(680, 620)">
                    <rect x="-80" y="-40" width="160" height="80" rx="10" fill="#DDD6FE" class="node-base"/>
                    <text x="0" y="0" class="node-text">é¡¯ç¤º 3æ ¼åœ–ç¤º</text>
                </g>
                 <!-- Stop 3 -->
                 <g id="node_stop_3" transform="translate(680, 720)">
                    <circle cx="0" cy="0" r="25" fill="#FCA5A5" class="node-base"/>
                    <text x="0" y="0" font-size="14" class="node-text">çµæŸ</text>
                </g>

                <!-- Decision: > 50 -->
                <g id="node_d_50" class="node-group" transform="translate(400, 780)">
                    <polygon points="0,-40 80,0 0,40 -80,0" fill="#FDBA74" class="node-base"/>
                    <text x="0" y="0" class="node-text">éŸ³é‡ > 50 ?</text>
                    <text x="90" y="-15" font-size="16" fill="#059669" font-weight="bold">æ˜¯</text>
                    <text x="15" y="60" font-size="16" fill="#DC2626" font-weight="bold">å¦</text>
                </g>

                <!-- Process: 2æ ¼ -->
                <g id="node_p_2" class="node-group" transform="translate(680, 780)">
                    <rect x="-80" y="-40" width="160" height="80" rx="10" fill="#DDD6FE" class="node-base"/>
                    <text x="0" y="0" class="node-text">é¡¯ç¤º 2æ ¼åœ–ç¤º</text>
                </g>
                 <!-- Stop 4 -->
                 <g id="node_stop_4" transform="translate(680, 880)">
                    <circle cx="0" cy="0" r="25" fill="#FCA5A5" class="node-base"/>
                    <text x="0" y="0" font-size="14" class="node-text">çµæŸ</text>
                </g>

                <!-- Process: 1æ ¼ (Else) -->
                <g id="node_p_1" class="node-group" transform="translate(400, 920)">
                    <rect x="-80" y="-40" width="160" height="80" rx="10" fill="#DDD6FE" class="node-base"/>
                    <text x="0" y="0" class="node-text">é¡¯ç¤º 1æ ¼åœ–ç¤º</text>
                </g>

                <!-- End Main -->
                <g id="node_end_main" class="node-group" transform="translate(400, 1050)">
                     <ellipse cx="0" cy="0" rx="80" ry="30" fill="#FCA5A5" class="node-base"/>
                    <text x="0" y="0" class="node-text">çµæŸ</text>
                </g>

            </svg>
        </div>

        <!-- Right Side: Controls & Info (ä½”å¤§è¢å¹• 1/3) -->
        <div class="lg:w-1/3 flex flex-col gap-4">

            <!-- Info Panel -->
            <div class="bg-white rounded-2xl shadow-lg border-4 border-orange-200 p-4 flex-grow flex flex-col">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 pb-2">ğŸ“‹ ç•¶å‰æ­¥é©Ÿèªªæ˜</h2>
                <div id="stepDescription" class="text-xl md:text-2xl text-gray-700 leading-relaxed flex-grow p-4 bg-orange-50 rounded-xl">
                    è«‹è¨­å®šåˆå§‹éŸ³é‡ï¼Œç„¶å¾ŒæŒ‰ä¸‹ã€Œæ¨¡æ“¬ P1 æŒ‰ä¸‹ã€é–‹å§‹ã€‚
                </div>
            </div>

            <!-- Volume Status Panel -->
            <div class="bg-white rounded-2xl shadow-lg border-4 border-blue-200 p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-xl font-bold text-gray-800">ğŸ”Š éŸ³é‡è®Šæ•¸: <span id="volumeValue" class="text-blue-600 text-3xl">250</span></h3>
                </div>
                <!-- Volume Icons -->
                <div class="flex gap-2 h-16 bg-gray-200 p-2 rounded-xl items-end justify-around" id="volumeIconDisplay">
                     <!-- Bars will be generated by JS or static here and toggled -->
                     <div class="volume-bar w-1/6 bg-gray-400 rounded-t-md h-[20%]" id="bar1"></div>
                     <div class="volume-bar w-1/6 bg-gray-400 rounded-t-md h-[40%]" id="bar2"></div>
                     <div class="volume-bar w-1/6 bg-gray-400 rounded-t-md h-[60%]" id="bar3"></div>
                     <div class="volume-bar w-1/6 bg-gray-400 rounded-t-md h-[80%]" id="bar4"></div>
                     <div class="volume-bar w-1/6 bg-gray-400 rounded-t-md h-[100%]" id="bar5"></div>
                </div>
                <div class="text-center text-gray-500 mt-1 font-bold" id="iconLabel">ç­‰å¾…é–‹å§‹...</div>
            </div>

            <!-- Controls Panel -->
            <div class="bg-white rounded-2xl shadow-lg border-4 border-green-200 p-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ® æ§åˆ¶å°</h3>

                <!-- Initial Settings -->
                <div class="flex gap-2 mb-4 items-center">
                     <label class="font-bold text-lg whitespace-nowrap">åˆå§‹éŸ³é‡:</label>
                     <input type="number" id="initialVolume" value="250" step="10" class="border-2 border-gray-300 rounded-lg p-2 text-xl w-full text-center focus:border-indigo-500" onchange="resetFlow()">
                </div>
                <button id="startBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-2xl font-bold py-4 px-6 rounded-xl shadow-md transition-all active:scale-95 mb-4">
                    â–¶ æ¨¡æ“¬ P1 æŒ‰ä¸‹ (é–‹å§‹)
                </button>

                <!-- Flow Controls -->
                <div class="grid grid-cols-2 gap-3">
                    <button id="prevBtn" class="bg-gray-500 hover:bg-gray-600 text-white text-xl font-bold py-3 rounded-xl shadow disabled:opacity-50 disabled:cursor-not-allowed">
                        â¬… ä¸Šä¸€æ­¥
                    </button>
                    <button id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white text-xl font-bold py-3 rounded-xl shadow disabled:opacity-50 disabled:cursor-not-allowed">
                        ä¸‹ä¸€æ­¥ â¡
                    </button>
                    <button id="yesBtn" class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 rounded-xl shadow disabled:opacity-50 disabled:cursor-not-allowed col-span-1">
                        âœ… æ˜¯ (True)
                    </button>
                    <button id="noBtn" class="bg-red-500 hover:bg-red-600 text-white text-xl font-bold py-3 rounded-xl shadow disabled:opacity-50 disabled:cursor-not-allowed col-span-1">
                        âŒ å¦ (False)
                    </button>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- è®Šæ•¸èˆ‡ç‹€æ…‹ ---
        let volume = 250;
        let currentStepId = null;
        let historyStack = [];
        let isRunning = false;

        // --- ç¯€é»å®šç¾© (State Machine) ---
        // å®šç¾©æ¯å€‹ç¯€é»çš„è¡Œç‚ºã€æ–‡å­—èªªæ˜ã€ä»¥åŠä¸‹ä¸€æ­¥çš„å»å‘
        const nodes = {
            'node_start': {
                type: 'start',
                text: "ç¨‹å¼é–‹å§‹ã€‚\nç­‰å¾…ä½¿ç”¨è€…æŒ‰ä¸‹ P1 æŒ‰éˆ•...",
                next: 'node_p_minus'
            },
            'node_p_minus': {
                type: 'process',
                text: "åŸ·è¡Œå‹•ä½œï¼š\nå°‡ã€ŒéŸ³é‡ã€è®Šæ•¸çš„å€¼æ¸›å°‘ 50ã€‚",
                action: () => { volume -= 50; },
                reverse: () => { volume += 50; }, // ç”¨æ–¼ä¸Šä¸€æ­¥
                next: 'node_d_200'
            },
            'node_d_200': {
                type: 'decision',
                text: "åˆ¤æ–·ï¼š\næª¢æŸ¥ç›®å‰ã€ŒéŸ³é‡ã€æ˜¯å¦å¤§æ–¼ 200ï¼Ÿ",
                condition: () => volume > 200,
                yes: 'node_p_full',
                no: 'node_d_150'
            },
            'node_p_full': {
                type: 'process',
                text: "æ¢ä»¶æˆç«‹ (Yes)ï¼š\nè¢å¹•é¡¯ç¤ºã€Œæ»¿æ ¼ã€éŸ³é‡åœ–ç¤ºã€‚",
                iconLevel: 5,
                next: 'node_stop_1'
            },
            'node_d_150': {
                type: 'decision',
                text: "åˆ¤æ–·ï¼š\næª¢æŸ¥ç›®å‰ã€ŒéŸ³é‡ã€æ˜¯å¦å¤§æ–¼ 150ï¼Ÿ",
                condition: () => volume > 150,
                yes: 'node_p_4',
                no: 'node_d_100'
            },
            'node_p_4': {
                type: 'process',
                text: "æ¢ä»¶æˆç«‹ (Yes)ï¼š\nè¢å¹•é¡¯ç¤ºã€Œ4æ ¼ã€éŸ³é‡åœ–ç¤ºã€‚",
                iconLevel: 4,
                next: 'node_stop_2'
            },
            'node_d_100': {
                type: 'decision',
                text: "åˆ¤æ–·ï¼š\næª¢æŸ¥ç›®å‰ã€ŒéŸ³é‡ã€æ˜¯å¦å¤§æ–¼ 100ï¼Ÿ",
                condition: () => volume > 100,
                yes: 'node_p_3',
                no: 'node_d_50'
            },
             'node_p_3': {
                type: 'process',
                text: "æ¢ä»¶æˆç«‹ (Yes)ï¼š\nè¢å¹•é¡¯ç¤ºã€Œ3æ ¼ã€éŸ³é‡åœ–ç¤ºã€‚",
                iconLevel: 3,
                next: 'node_stop_3'
            },
            'node_d_50': {
                type: 'decision',
                text: "åˆ¤æ–·ï¼š\næª¢æŸ¥ç›®å‰ã€ŒéŸ³é‡ã€æ˜¯å¦å¤§æ–¼ 50ï¼Ÿ",
                condition: () => volume > 50,
                yes: 'node_p_2',
                no: 'node_p_1'
            },
            'node_p_2': {
                type: 'process',
                text: "æ¢ä»¶æˆç«‹ (Yes)ï¼š\nè¢å¹•é¡¯ç¤ºã€Œ2æ ¼ã€éŸ³é‡åœ–ç¤ºã€‚",
                iconLevel: 2,
                next: 'node_stop_4'
            },
            'node_p_1': {
                type: 'process',
                text: "ä»¥ä¸Šæ¢ä»¶éƒ½ä¸æˆç«‹ (No)ï¼š\nè¢å¹•é¡¯ç¤ºã€Œ1æ ¼ã€éŸ³é‡åœ–ç¤ºã€‚",
                iconLevel: 1,
                next: 'node_end_main'
            },
            // çµæŸç¯€é»å€‘
            'node_stop_1': { type: 'end', text: "æœ¬æ¬¡æµç¨‹çµæŸã€‚", iconLevel: 5 },
            'node_stop_2': { type: 'end', text: "æœ¬æ¬¡æµç¨‹çµæŸã€‚", iconLevel: 4 },
            'node_stop_3': { type: 'end', text: "æœ¬æ¬¡æµç¨‹çµæŸã€‚", iconLevel: 3 },
            'node_stop_4': { type: 'end', text: "æœ¬æ¬¡æµç¨‹çµæŸã€‚", iconLevel: 2 },
            'node_end_main': { type: 'end', text: "æœ¬æ¬¡æµç¨‹çµæŸã€‚", iconLevel: 1 }
        };

        // --- DOM å…ƒç´  ---
        const elVolumeVal = document.getElementById('volumeValue');
        const elStepDesc = document.getElementById('stepDescription');
        const elIconLabel = document.getElementById('iconLabel');
        const btnStart = document.getElementById('startBtn');
        const btnPrev = document.getElementById('prevBtn');
        const btnNext = document.getElementById('nextBtn');
        const btnYes = document.getElementById('yesBtn');
        const btnNo = document.getElementById('noBtn');
        const bars = [
            document.getElementById('bar1'),
            document.getElementById('bar2'),
            document.getElementById('bar3'),
            document.getElementById('bar4'),
            document.getElementById('bar5')
        ];

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---

        function updateUI() {
            // æ›´æ–°éŸ³é‡é¡¯ç¤º
            elVolumeVal.textContent = volume;

            // æ›´æ–°éŸ³é‡åœ–ç¤º (æ ¹æ“šè®Šæ•¸å€¼ï¼Œè€Œéåƒ…æ ¹æ“šç•¶å‰ç¯€é»ã€‚ä½†ç‚ºäº†æ•™å­¸ï¼Œæˆ‘å€‘åªåœ¨æœ€å¾Œæ‰æ›´æ–°åœ–ç¤ºï¼Ÿ)
            // ä¸ï¼Œé¡Œç›®èªªã€Œä¾æ“šéŸ³é‡æ•¸å€¼åˆ¤æ–·é¡¯ç¤ºã€ï¼Œé€™é€šå¸¸æ˜¯å³æ™‚çš„ï¼Œæˆ–è€…åœ¨ç‰¹å®šæ­¥é©ŸåŸ·è¡Œã€‚
            // æˆ‘å€‘åœ¨é€²å…¥ 'process' é¡¯ç¤ºåœ–ç¤ºçš„ç¯€é»æ™‚æ‰æ›´æ–°åœ–ç¤ºï¼Œæ¯”è¼ƒç¬¦åˆæµç¨‹åœ–é‚è¼¯ã€‚
            // ä½†ç‚ºäº†è®“å­¸ç”Ÿä¸€ç›´çœ‹åˆ°è®Šæ•¸å°æ‡‰çš„æ½›åœ¨ç‹€æ…‹ï¼Œæˆ‘å€‘é‚„æ˜¯å³æ™‚æ›´æ–°æ¯”è¼ƒå¥½è§€å¯Ÿã€‚
            // *ä¿®æ­£*ï¼šåš´æ ¼æŒ‰ç…§æµç¨‹åœ–ï¼Œåªæœ‰åŸ·è¡Œåˆ° "é¡¯ç¤ºXæ ¼" æ™‚ï¼Œè¢å¹•ä¸Šçš„åœ–ç¤ºæ‰æœƒè®Šã€‚
            // ç‚ºäº†æ•™å­¸æ¸…æ™°ï¼Œæˆ‘å€‘åœ¨ UI ä¸Šä¿æŒä¸€å€‹ "é è¦½" æˆ–åœ¨æµç¨‹åœ–èµ°åˆ°é‚£ä¸€æ­¥æ™‚æ‰çœŸæ­£äº®èµ·ã€‚
            // é€™è£¡é¸æ“‡ï¼šéš¨æ™‚æ›´æ–°åº•å±¤è®Šæ•¸é¡¯ç¤ºï¼Œä½†åœ–ç¤ºåªåœ¨åˆ°é”ç‰¹å®šç¯€é»æ™‚ã€Œç¢ºèªã€é¡¯ç¤ºã€‚
            // *å†ä¿®æ­£*ï¼šç‚ºäº†äº’å‹•æ€§ï¼Œæˆ‘å€‘è®“åœ–ç¤ºä¸€ç›´åæ˜ ç›®å‰çš„ volume æ½›åœ¨ç­‰ç´šï¼Œä½†ç”¨é¡è‰²å€åˆ†ã€Œå·²ç¢ºèªã€å’Œã€Œé è¦½ã€ã€‚
            // ç°¡å–®é»ï¼šå°±è®“å®ƒä¸€ç›´åæ˜  volume å¥½äº†ï¼Œé€™æ¨£å­¸ç”Ÿèƒ½é åˆ¤ã€‚
            updateVolumeIcons(volume);

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            if (!isRunning) {
                btnPrev.disabled = true;
                btnNext.disabled = true;
                btnYes.disabled = true;
                btnNo.disabled = true;
                return;
            }

            const node = nodes[currentStepId];
            btnPrev.disabled = historyStack.length === 0;

            if (node.type === 'decision') {
                btnNext.disabled = true;
                btnYes.disabled = false;
                btnNo.disabled = false;
                // é«˜äº®æç¤ºï¼šå¯ä»¥åœ¨é€™è£¡ä½œå¼Šè®“æ­£ç¢ºç­”æ¡ˆé–ƒçˆï¼Œä½†æˆ‘å€‘é¸æ“‡è®“å­¸ç”Ÿæ€è€ƒï¼Œé¸éŒ¯å†æç¤ºã€‚
            } else if (node.type === 'end') {
                btnNext.disabled = true;
                btnYes.disabled = true;
                btnNo.disabled = true;
            } else {
                // start, process
                btnNext.disabled = false;
                btnYes.disabled = true;
                btnNo.disabled = true;
            }
        }

        function updateVolumeIcons(vol) {
            // å…ˆé‡ç½®æ‰€æœ‰æ ¼å­é¡è‰²
            bars.forEach(b => b.className = b.className.replace(/bg-\w+-500/g, 'bg-gray-400'));

            let level = 1;
            if (vol > 200) level = 5;
            else if (vol > 150) level = 4;
            else if (vol > 100) level = 3;
            else if (vol > 50) level = 2;
            else level = 1;

            // æ ¹æ“š level ä¸Šè‰²
            const activeColor = 'bg-green-500';
             // ç‰¹æ®Šè™•ç†ï¼šæ»¿æ ¼æ™‚ç”¨ç´…è‰²è¡¨ç¤ºå¤§è²
            const finalColor = (level === 5) ? 'bg-red-500' : (level >= 3 ? 'bg-yellow-500' : 'bg-green-500');

            for (let i = 0; i < level; i++) {
                bars[i].className = bars[i].className.replace('bg-gray-400', finalColor);
            }
            elIconLabel.textContent = `ç›®å‰ç¬¦åˆï¼š${level} æ ¼éŸ³é‡æ¨™æº–`;
        }

        function highlightNode(nodeId) {
            // æ¸…é™¤èˆŠçš„é«˜äº®
            document.querySelectorAll('.active-node').forEach(el => el.classList.remove('active-node'));
            // æ–°å¢é«˜äº®
            const target = document.getElementById(nodeId);
            if (target) {
                // æ‰¾åˆ°è©² group ä¸‹çš„å½¢ç‹€ (rect, polygon, ellipse, circle)
                const shape = target.querySelector('.node-base');
                if (shape) shape.classList.add('active-node');
                // æ»¾å‹•åˆ°å¯è¦‹ (å¦‚æœåœ–å¤ªå¤§)
                target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            }
        }

        function setStep(stepId, isBack = false) {
            if (!isBack && currentStepId) {
                // è¨˜éŒ„æ­·å²ç‹€æ…‹ (Deep copy volume if it was an object, but it's primitive)
                historyStack.push({ step: currentStepId, vol: volume });
            }

            currentStepId = stepId;
            const node = nodes[stepId];

            // åŸ·è¡Œç¯€é»å‹•ä½œ (å¦‚æœæ˜¯å‰é€²ä¸”æœ‰å‹•ä½œ)
            if (!isBack && node.action) {
                node.action();
            }

            // æ›´æ–°ç•«é¢
            highlightNode(stepId);
            elStepDesc.innerText = node.text;

            // å¦‚æœæ˜¯åˆ¤æ–·ç¯€é»ï¼Œå¢åŠ å¼•å°æ–‡å­—
            if (node.type === 'decision') {
                 elStepDesc.innerText += `\n\nğŸ‘‰ è«‹è§€å¯Ÿç›®å‰éŸ³é‡ (${volume})ï¼Œç„¶å¾Œé»é¸ã€Œæ˜¯ã€æˆ–ã€Œå¦ã€ã€‚`;
            }

            updateUI();
        }

        // --- æŒ‰éˆ•äº‹ä»¶è™•ç† ---

        function resetFlow() {
            isRunning = false;
            currentStepId = null;
            historyStack = [];
            volume = parseInt(document.getElementById('initialVolume').value) || 250;
            // æ¸…é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.active-node').forEach(el => el.classList.remove('active-node'));
            elStepDesc.innerText = "å·²é‡ç½®ã€‚è«‹è¨­å®šåˆå§‹éŸ³é‡ï¼Œç„¶å¾ŒæŒ‰ä¸‹ã€Œæ¨¡æ“¬ P1 æŒ‰ä¸‹ã€é–‹å§‹ã€‚";
            updateUI();
        }

        btnStart.onclick = () => {
            resetFlow(); // ç¢ºä¿å¾é ­é–‹å§‹
            isRunning = true;
            setStep('node_start');
        };

        btnNext.onclick = () => {
            if (!currentStepId || !isRunning) return;
            const node = nodes[currentStepId];
            if (node.next) {
                setStep(node.next);
            }
        };

        btnPrev.onclick = () => {
            if (historyStack.length > 0) {
                const prevState = historyStack.pop();
                // å¦‚æœç•¶å‰ç¯€é»æœ‰åå‘å‹•ä½œ (ä¾‹å¦‚åŠ å›éŸ³é‡)ï¼Œéœ€è¦åŸ·è¡Œ
                // ä½†å› ç‚ºæˆ‘å€‘å„²å­˜äº†å®Œæ•´çš„æ­·å²ç‹€æ…‹ (vol)ï¼Œç›´æ¥æ¢å¾©æ•¸å€¼æ›´å®‰å…¨
                volume = prevState.vol;
                currentStepId = prevState.step; // ä¸ä½¿ç”¨ setStep é¿å…é‡è¤‡æ¨å…¥æ­·å²
                
                // æ‰‹å‹•åŸ·è¡Œ setStep çš„ UI æ›´æ–°éƒ¨åˆ†
                const node = nodes[currentStepId];
                highlightNode(currentStepId);
                elStepDesc.innerText = node.text;
                if (node.type === 'decision') {
                     elStepDesc.innerText += `\n\nğŸ‘‰ è«‹è§€å¯Ÿç›®å‰éŸ³é‡ (${volume})ï¼Œç„¶å¾Œé»é¸ã€Œæ˜¯ã€æˆ–ã€Œå¦ã€ã€‚`;
                }
                updateUI();
            }
        };

        function handleDecision(userChoiceYes) {
            if (!currentStepId || !isRunning) return;
            const node = nodes[currentStepId];
            if (node.type !== 'decision') return;

            const actualResult = node.condition();

            if (userChoiceYes === actualResult) {
                // ç­”å°äº†ï¼Œå‰é€²
                setStep(actualResult ? node.yes : node.no);
            } else {
                // ç­”éŒ¯äº†ï¼Œæç¤º
                const nodeEl = document.getElementById(currentStepId);
                nodeEl.classList.add('shake-node');
                setTimeout(() => nodeEl.classList.remove('shake-node'), 500);
                
                // é¡¯ç¤ºæç¤ºè¨Šæ¯
                const originalText = node.text;
                elStepDesc.innerText = `ğŸ’¡ ç­‰ç­‰ï¼å†çœ‹ä¸€æ¬¡ã€‚\nç›®å‰éŸ³é‡æ˜¯ ${volume}ã€‚\n\n${originalText}\n\n(æç¤ºï¼š${volume} ${actualResult ? 'å¤§æ–¼' : 'ä¸å¤§æ–¼'} ${node.text.match(/\d+/)[0]} å–”ï¼)`;
            }
        }

        btnYes.onclick = () => handleDecision(true);
        btnNo.onclick = () => handleDecision(false);

        // åˆå§‹åŒ–
        resetFlow();

    </script>
</body>
</html>