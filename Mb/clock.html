<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ƒå¹´ç´šå¯’å‡æˆ°é¬¥è¨ˆç•« (1/26-2/15)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Custom Scrollbar */
        .scroller::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scroller::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .scroller::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .scroller::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .goal-card {
            transition: all 0.2s ease-in-out;
        }
        .goal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .completed-row {
            background-color: #ecfdf5 !important; /* green-50 */
        }
        .completed-row input[type="text"] {
            color: #065f46; /* green-800 */
            text-decoration: line-through;
        }
        
        /* Pomodoro Animation */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .timer-active {
            animation: pulse-red 2s infinite;
            border-color: #ef4444 !important;
        }

        /* Stock Ticker Animation */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #1e293b;
            color: white;
            white-space: nowrap;
            box-sizing: border-box;
        }
        .ticker {
            display: inline-block;
            padding-left: 100%;
            animation: ticker 30s linear infinite;
        }
        .ticker__item {
            display: inline-block;
            padding: 0 2rem;
            font-size: 0.875rem;
            font-weight: bold;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
        .up { color: #4ade80; } /* Green for up */
        .down { color: #f87171; } /* Red for down/warning */
    </style>
</head>
<body class="text-gray-800 flex flex-col min-h-screen">

    <!-- Stock Market Style Ticker -->
    <div class="ticker-wrap py-2 border-b border-gray-700">
        <div class="ticker">
            <div class="ticker__item">ä»Šæ—¥å­¸ç¿’æŒ‡æ•¸ <span class="up">â–² 150.2</span></div>
            <div class="ticker__item">å°ˆæ³¨åŠ›æœŸè²¨ <span class="up">â–² 45åˆ†é˜</span></div>
            <div class="ticker__item">ç²—å¿ƒç‡ <span class="down">â–¼ 0.5% (ç›®æ¨™: 0%)</span></div>
            <div class="ticker__item">è‹±æ–‡å–®å­—åº«å­˜ <span class="up">â–² ç´¯ç©ä¸­</span></div>
            <div class="ticker__item">æ‰‹æ©Ÿå¹²æ“¾ <span class="down">â–¼ å¼·åŠ›è³£å‡º</span></div>
            <div class="ticker__item">é«”èƒ½å„²å‚™ <span class="up">â–² ç©©å®šæŒå€‰</span></div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-6 flex-grow w-full">
        
        <!-- Header & Date Picker -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-5 rounded-xl shadow-md border border-gray-100">
            <div>
                <h1 class="text-2xl md:text-3xl font-black text-slate-800 tracking-tight flex items-center">
                    <i class="fas fa-chart-line text-blue-600 mr-3"></i>
                    ä¸ƒå¹´ç´šå¯’å‡æˆ°é¬¥è¨ˆç•«
                </h1>
                <p class="text-gray-500 text-sm mt-1 ml-1">æŠ•è³‡å¤§è…¦æ˜¯å›å ±ç‡æœ€é«˜çš„äº¤æ˜“ | äº¤æ˜“å€é–“: 01/26 - 02/15</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center bg-slate-100 p-2 rounded-lg border border-slate-200">
                <label for="planDate" class="mr-3 font-bold text-slate-700"><i class="far fa-calendar-alt mr-1"></i>äº¤æ˜“æ—¥æœŸï¼š</label>
                <input type="date" id="planDate" class="bg-white border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 text-slate-700 font-bold">
            </div>
        </header>

        <!-- 5 Core Goals (Sticky/Top) -->
        <section id="goals" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <!-- è²¬ä»»å¿ƒ -->
            <div class="goal-card bg-white border-t-4 border-blue-500 p-4 rounded-lg shadow-sm">
                <div class="flex items-center mb-2 justify-between">
                    <h3 class="text-lg font-black text-gray-800">è²¬ä»»å¿ƒ</h3>
                    <i class="fas fa-user-tie text-blue-500 text-xl"></i>
                </div>
                <p class="text-xs text-gray-600 font-bold leading-relaxed">æ‰¿æ“”å­¸ç”Ÿæœ¬è·ï¼Œæ¯å¤©æº–æ™‚æŒ‰è¨ˆç•«åŸ·è¡Œä»»å‹™ã€‚</p>
            </div>
            <!-- æ±ºå¿ƒ -->
            <div class="goal-card bg-white border-t-4 border-red-500 p-4 rounded-lg shadow-sm">
                <div class="flex items-center mb-2 justify-between">
                    <h3 class="text-lg font-black text-gray-800">æ±ºå¿ƒ</h3>
                    <i class="fas fa-fire text-red-500 text-xl"></i>
                </div>
                <p class="text-xs text-gray-600 font-bold leading-relaxed">è¨­å®šæ˜ç¢ºç›®æ¨™å¾Œå…¨åŠ›ä»¥èµ´ï¼Œä¸è¼•è¨€æ”¾æ£„ã€‚</p>
            </div>
            <!-- ç´°å¿ƒ -->
            <div class="goal-card bg-white border-t-4 border-yellow-500 p-4 rounded-lg shadow-sm">
                <div class="flex items-center mb-2 justify-between">
                    <h3 class="text-lg font-black text-gray-800">ç´°å¿ƒ</h3>
                    <i class="fas fa-microscope text-yellow-500 text-xl"></i>
                </div>
                <p class="text-xs text-gray-600 font-bold leading-relaxed">è®€æ›¸èˆ‡ä½œé¡Œæ™‚æ³¨é‡ç´°ç¯€ï¼Œæ¸›å°‘ç²—å¿ƒéŒ¯èª¤ã€‚</p>
            </div>
            <!-- è€å¿ƒ -->
            <div class="goal-card bg-white border-t-4 border-purple-500 p-4 rounded-lg shadow-sm">
                <div class="flex items-center mb-2 justify-between">
                    <h3 class="text-lg font-black text-gray-800">è€å¿ƒ</h3>
                    <i class="fas fa-brain text-purple-500 text-xl"></i>
                </div>
                <p class="text-xs text-gray-600 font-bold leading-relaxed">é¢å°é›£é¡Œæˆ–æ¯ç‡¥å…§å®¹æ™‚ä¿æŒå†·éœï¼Œåè¦†ç ”ç£¨ã€‚</p>
            </div>
            <!-- è¦å¾‹ -->
            <div class="goal-card bg-white border-t-4 border-green-500 p-4 rounded-lg shadow-sm">
                <div class="flex items-center mb-2 justify-between">
                    <h3 class="text-lg font-black text-gray-800">è¦å¾‹</h3>
                    <i class="fas fa-sync-alt text-green-500 text-xl"></i>
                </div>
                <p class="text-xs text-gray-600 font-bold leading-relaxed">ç¶­æŒç©©å®šä½œæ¯ï¼Œå°‡å­¸ç¿’èˆ‡é‹å‹•å…§åŒ–ç‚ºæ—¥å¸¸ç¿’æ…£ã€‚</p>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <!-- Main Schedule Table (Takes up 3 columns) -->
            <main class="lg:col-span-3 bg-white rounded-xl shadow-md overflow-hidden flex flex-col border border-gray-100">
                <div class="p-4 bg-slate-50 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-2">
                    <h2 class="text-lg font-bold text-slate-700 flex items-center">
                        <i class="fas fa-list-check mr-2 text-slate-500"></i>ä»Šæ—¥åŸ·è¡Œé€²åº¦
                    </h2>
                    <span id="dayTypeLabel" class="text-xs font-bold px-3 py-1.5 rounded-full bg-blue-100 text-blue-700 border border-blue-200 shadow-sm">è®€å–ä¸­...</span>
                </div>
                
                <div class="overflow-x-auto scroller flex-grow">
                    <table class="w-full text-left border-collapse min-w-[600px]">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 text-sm uppercase leading-normal sticky top-0 z-10">
                                <th class="py-3 px-4 font-bold text-center w-24 border-b border-gray-200">æ™‚é–“</th>
                                <th class="py-3 px-4 font-bold w-40 border-b border-gray-200">ç§‘ç›®/é …ç›®</th>
                                <th class="py-3 px-4 font-bold border-b border-gray-200">åŸ·è¡Œå…§å®¹èˆ‡ç›®æ¨™ <span class="text-xs font-normal text-gray-400 normal-case ml-1">(é»æ“Šè¼¸å…¥)</span></th>
                                <th class="py-3 px-4 font-bold text-center w-20 border-b border-gray-200">å®Œæˆ</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody" class="text-gray-700 text-sm font-medium">
                            <!-- Javascript will render rows here -->
                        </tbody>
                    </table>
                </div>
            </main>

            <!-- Sidebar: Pomodoro & Controls (Takes up 1 column) -->
            <aside class="space-y-6">
                
                <!-- Pomodoro Timer -->
                <div class="bg-white rounded-xl shadow-md p-6 text-center border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-red-400 to-orange-400"></div>
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex justify-center items-center">
                        <i class="fas fa-stopwatch mr-2 text-red-500"></i>å°ˆæ³¨è¨ˆæ™‚å™¨
                    </h3>
                    
                    <div id="timerDisplay" class="text-6xl font-mono font-black text-slate-800 mb-6 tracking-widest bg-slate-50 rounded-lg py-2 border border-slate-200">
                        45:00
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="setTimer(45)" class="px-2 py-2 text-xs font-bold bg-slate-100 text-slate-600 rounded hover:bg-slate-200 transition">
                            <i class="fas fa-book mr-1"></i>å­¸ç¿’ 45åˆ†
                        </button>
                        <button onclick="setTimer(10)" class="px-2 py-2 text-xs font-bold bg-green-100 text-green-700 rounded hover:bg-green-200 transition">
                            <i class="fas fa-coffee mr-1"></i>ä¼‘æ¯ 10åˆ†
                        </button>
                    </div>

                    <div class="flex justify-center space-x-3">
                        <button id="startBtn" onclick="toggleTimer()" class="flex-grow py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95">
                            <i class="fas fa-play mr-1"></i> é–‹å§‹è¨ˆæ™‚
                        </button>
                        <button onclick="resetTimer()" class="w-12 py-3 bg-gray-200 text-gray-600 font-bold rounded-lg hover:bg-gray-300 transition active:scale-95">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>

                <!-- Stats & Export -->
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                    <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-clipboard-check mr-2 text-green-600"></i>æ—¥çµç®—é¢æ¿
                    </h3>
                    
                    <div id="progressStats" class="mb-5">
                        <div class="flex justify-between mb-1">
                            <span class="text-xs font-bold text-gray-500">ä»Šæ—¥é”æˆç‡</span>
                            <span id="progressText" class="text-xs font-bold text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button onclick="exportDailyReport()" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg shadow-green-200 hover:bg-green-700 transition flex items-center justify-center active:scale-95 group">
                        <i class="fas fa-file-export mr-2 group-hover:animate-bounce"></i> åŒ¯å‡ºæª¢è¨å ±å‘Š
                    </button>
                    <p class="text-[10px] text-gray-400 mt-3 text-center">
                        <i class="fas fa-info-circle mr-1"></i>æ¯æ—¥18:45åŸ·è¡Œçµç®—ï¼Œå»ºç«‹è² è²¬çš„äº¤æ˜“ç´€éŒ„ã€‚
                    </p>
                </div>

            </aside>
        </div>

        <footer class="mt-8 mb-4 text-center text-gray-400 text-xs">
            <p>Â© 2026 ä¸ƒå¹´ç´šå¯’å‡æˆé•·è¨ˆç•« | Discipline Equals Freedom</p>
        </footer>

    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Configuration & Data ---
        const START_DATE = "2026-01-26";
        const END_DATE = "2026-02-15";
        
        // baseSchedule defines the structure of a day.
        // dynamic: true means content changes based on Plan A (Mon/Wed/Fri) or Plan B (Others)
        const baseSchedule = [
            { time: "09:00 - 09:15", title: "æ™¨é–“ç›®æ¨™è¨­å®š", desc: "æœ—è®€åŠ æ²¹é …ç›® (è²¬ä»»ã€æ±ºå¿ƒã€ç´°å¿ƒã€è€å¿ƒã€è¦å¾‹)", type: "routine" },
            { time: "09:15 - 10:00", title: "æ•¸å­¸ (1)", desc: "", placeholder: "é€²åº¦ (å¦‚: 1-1 ä»£å…¥æ¶ˆå»æ³• p.5-8)", type: "core" },
            { time: "10:00 - 10:10", title: "ä¼¸å±•ä¼‘æ¯", desc: "å–æ°´ã€é çœº", type: "break" },
            { time: "10:10 - 10:55", title: "æ•¸å­¸ (2)", desc: "", placeholder: "é€²åº¦ (å¦‚: ç›´è§’åº§æ¨™æ‡‰ç”¨é¡Œ)", type: "core" },
            { time: "10:55 - 11:10", title: "å¤§ä¼‘æ¯", desc: "é»å¿ƒã€è‡ªç”±æ´»å‹•", type: "break" },
            { time: "11:10 - 11:55", title: "è‹±æ–‡ (åŸºç¤)", desc: "", placeholder: "å–®å­—èƒŒèª¦ã€æ–‡æ³•é ç¿’", type: "core" },
            { time: "12:00 - 13:30", title: "åˆé¤èˆ‡åˆä¼‘", desc: "å¾¹åº•æ”¾é¬†ï¼Œè½å¯¦è¦å¾‹ä½œæ¯", type: "break" },
            
            // Dynamic Slot (Index 7)
            { time: "13:30 - 14:15", title: "å½ˆæ€§æ™‚æ®µ", dynamic: true, desc: "", placeholder: "", type: "core" },
            
            { time: "14:15 - 14:25", title: "ä¼‘æ¯æ™‚é–“", desc: "é–‰çœ¼ä¼‘æ¯", type: "break" },
            { time: "14:25 - 15:10", title: "è‡ªç„¶ (æ ¸å¿ƒ)", desc: "", placeholder: "é€²åº¦ (å¦‚: éºå‚³æ³•å‰‡èˆ‡æ£‹ç›¤æ–¹æ ¼)", type: "core" },
            { time: "15:10 - 15:30", title: "é»å¿ƒæ™‚é–“", desc: "è£œå……èƒ½é‡", type: "break" },
            { time: "15:30 - 16:15", title: "åœ‹æ–‡ (1)", desc: "", placeholder: "é€²åº¦ (å¦‚: èª²æ–‡å°è®€)", type: "core" },
            { time: "16:15 - 16:25", title: "ä¼‘æ¯æ™‚é–“", desc: "æ•´ç†æ¡Œé¢", type: "break" },
            { time: "16:25 - 17:10", title: "åœ‹æ–‡ (2)", desc: "", placeholder: "æ–‡è¨€æ–‡é–±è®€/æˆèª", type: "core" },
            { time: "17:10 - 18:00", title: "é«”èƒ½é‹å‹•", desc: "è½å¯¦ã€Œæ±ºå¿ƒã€ï¼Œæµæ±—æ’æ¯’ (è·³ç¹©/æ…¢è·‘)", type: "routine" },
            { time: "18:00 - 18:45", title: "æ™šé¤æ™‚é–“", desc: "ç‡Ÿé¤Šå‡è¡¡", type: "break" },
            { time: "18:45 - 19:00", title: "è²¬ä»»å›é¡§", desc: "æª¢è¦–ä»Šæ—¥é€²åº¦ï¼Œæ•´ç†æ›¸åŒ…", type: "routine" }
        ];

        // Global State
        let currentDate = "";
        let scheduleData = {}; // Stores content and checked state per date
        let timerInterval;
        let timerSeconds = 45 * 60;
        let isTimerRunning = false;

        // --- Initialization ---
        window.onload = function() {
            // Initialize Date Picker
            const today = new Date().toISOString().split('T')[0];
            const picker = document.getElementById('planDate');
            
            // Default to plan start date if today is before it, or today if within range
            if (today >= START_DATE && today <= END_DATE) {
                picker.value = today;
            } else if (today < START_DATE) {
                picker.value = START_DATE;
            } else {
                picker.value = END_DATE;
            }
            
            // Load saved data
            const savedData = localStorage.getItem('winterPlanData_v2'); // v2 to avoid conflicts
            if (savedData) {
                scheduleData = JSON.parse(savedData);
            }

            // Initial Render
            currentDate = picker.value;
            renderSchedule(currentDate);

            // Change Listener
            picker.addEventListener('change', (e) => {
                currentDate = e.target.value;
                renderSchedule(currentDate);
            });
            
            // Ask for notification permission (optional)
            if ("Notification" in window && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        };

        // --- Schedule Rendering Logic ---
        function renderSchedule(dateStr) {
            const dateObj = new Date(dateStr);
            const dayOfWeek = dateObj.getDay(); // 0=Sun, 1=Mon...
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = "";

            // Plan A/B Logic
            // Plan A (Mon/Wed/Fri): English Video/Mag
            // Plan B (Tue/Thu/Sat/Sun): Natural Science
            const isPlanA = [1, 3, 5].includes(dayOfWeek);
            
            const dynamicTitle = isPlanA 
                ? '<span class="text-blue-600"><i class="fas fa-film mr-1"></i>è‹±æ–‡ (å½±é›†/é›œèªŒ)</span>' 
                : '<span class="text-green-600"><i class="fas fa-leaf mr-1"></i>è‡ªç„¶ (Session 1)</span>';
            const dynamicPlaceholder = isPlanA
                ? "è¼¸å…¥å½±é›†åç¨±æˆ–é–±è®€ç´ æ"
                : "è¼¸å…¥ç”Ÿç‰©é ç¿’å–®å…ƒ";
            
            const dayLabel = document.getElementById('dayTypeLabel');
            const dayNames = "æ—¥ä¸€äºŒä¸‰å››äº”å…­";
            dayLabel.innerHTML = isPlanA 
                ? `<i class="fas fa-bolt mr-1"></i>é€±${dayNames[dayOfWeek]}ï¼šè‹±æ–‡å¼·åŒ–æ—¥` 
                : `<i class="fas fa-tree mr-1"></i>é€±${dayNames[dayOfWeek]}ï¼šè‡ªç„¶ç´®æ ¹æ—¥`;
            dayLabel.className = isPlanA 
                ? "text-xs font-bold px-3 py-1.5 rounded-full bg-blue-100 text-blue-700 border border-blue-200"
                : "text-xs font-bold px-3 py-1.5 rounded-full bg-green-100 text-green-700 border border-green-200";

            // Get data for this day
            const dayData = scheduleData[dateStr] || {};

            baseSchedule.forEach((item, index) => {
                let row = document.createElement('tr');
                row.className = "border-b border-gray-100 hover:bg-slate-50 transition group";
                
                // Content Handling
                let displayTitle = item.title;
                let placeholder = item.placeholder;
                
                if (item.dynamic) {
                    displayTitle = dynamicTitle;
                    placeholder = dynamicPlaceholder;
                }

                // Retrieve saved state
                const key = `${index}_${item.time}`; 
                const savedContent = dayData[key]?.content || "";
                const isDone = dayData[key]?.done || false;

                if (isDone) row.classList.add('completed-row');

                // 1. Time Column
                let timeCell = `<td class="py-3 px-4 text-center whitespace-nowrap font-bold text-slate-500 font-mono text-xs">${item.time}</td>`;
                
                // 2. Title Column
                let titleCell = `<td class="py-3 px-4 font-bold text-slate-700">${displayTitle}</td>`;
                
                // 3. Input/Description Column
                let contentCell = "";
                if (item.type === 'break') {
                    row.className = "bg-gray-50 border-b border-gray-100 text-gray-400"; 
                    contentCell = `<td class="py-3 px-4 text-xs italic"><i class="fas fa-mug-hot mr-1"></i>${item.desc}</td>`;
                } else if (item.type === 'routine') {
                    contentCell = `<td class="py-3 px-4 text-slate-500 text-xs font-medium">${item.desc}</td>`;
                } else {
                    // Core Editable Item
                    contentCell = `<td class="py-3 px-4 relative">
                        <input type="text" 
                            class="w-full bg-transparent border-b border-transparent group-hover:border-gray-300 focus:border-blue-500 focus:outline-none py-1 text-slate-700 placeholder-gray-300 transition-colors" 
                            placeholder="${placeholder}" 
                            value="${savedContent}"
                            oninput="saveRow(${index}, '${item.time}', this.value)"
                        >
                    </td>`;
                }

                // 4. Checkbox Column
                let checkCell = "";
                if (item.type !== 'break') {
                    checkCell = `<td class="py-3 px-4 text-center">
                        <div class="inline-flex items-center justify-center relative">
                            <input type="checkbox" 
                                class="peer h-5 w-5 cursor-pointer appearance-none rounded border border-slate-300 shadow-sm checked:bg-blue-600 checked:border-blue-600 transition-all"
                                ${isDone ? 'checked' : ''}
                                onchange="toggleDone(${index}, '${item.time}', this.checked)"
                            >
                            <span class="absolute text-white opacity-0 peer-checked:opacity-100 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none text-xs">
                                <i class="fas fa-check"></i>
                            </span>
                        </div>
                    </td>`;
                } else {
                    checkCell = `<td></td>`;
                }

                row.innerHTML = timeCell + titleCell + contentCell + checkCell;
                tbody.appendChild(row);
            });
            
            updateProgress();
        }

        // --- Data Logic ---
        function saveRow(index, timeStr, content) {
            if (!scheduleData[currentDate]) scheduleData[currentDate] = {};
            const key = `${index}_${timeStr}`;
            
            let current = scheduleData[currentDate][key] || {};
            // Only update content, keep done status
            scheduleData[currentDate][key] = {
                content: content,
                done: current.done || false
            };
            
            localStorage.setItem('winterPlanData_v2', JSON.stringify(scheduleData));
        }

        function toggleDone(index, timeStr, isChecked) {
            if (!scheduleData[currentDate]) scheduleData[currentDate] = {};
            const key = `${index}_${timeStr}`;
            
            let current = scheduleData[currentDate][key] || {};
            // Update done status
            scheduleData[currentDate][key] = {
                content: current.content || "",
                done: isChecked
            };
            
            localStorage.setItem('winterPlanData_v2', JSON.stringify(scheduleData));
            
            // Visual feedback without full re-render
            const rows = document.getElementById('scheduleBody').children;
            if (isChecked) {
                rows[index].classList.add('completed-row');
            } else {
                rows[index].classList.remove('completed-row');
            }
            updateProgress();
        }

        function updateProgress() {
            const dayData = scheduleData[currentDate] || {};
            const trackableItems = baseSchedule.filter(i => i.type !== 'break');
            const total = trackableItems.length;
            
            let completed = 0;
            baseSchedule.forEach((item, idx) => {
                if (item.type === 'break') return;
                const key = `${idx}_${item.time}`;
                if (dayData[key]?.done) completed++;
            });

            const percent = Math.round((completed / total) * 100);
            document.getElementById('progressBar').style.width = percent + "%";
            document.getElementById('progressText').innerText = percent + "%";
        }

        // --- Pomodoro Logic ---
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function updateTimerDisplay() {
            document.getElementById('timerDisplay').innerText = formatTime(timerSeconds);
            document.title = `${formatTime(timerSeconds)} - å°ˆæ³¨è¨ˆæ™‚`;
        }

        function setTimer(minutes) {
            stopTimer();
            timerSeconds = minutes * 60;
            updateTimerDisplay();
            document.getElementById('timerDisplay').parentElement.classList.remove('timer-active');
            
            const btn = document.getElementById('startBtn');
            btn.innerHTML = '<i class="fas fa-play mr-1"></i> é–‹å§‹è¨ˆæ™‚';
            btn.className = "flex-grow py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95";
        }

        function toggleTimer() {
            if (isTimerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            isTimerRunning = true;
            const btn = document.getElementById('startBtn');
            btn.innerHTML = '<i class="fas fa-pause mr-1"></i> æš«åœ';
            btn.className = "flex-grow py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition shadow-lg shadow-yellow-200 active:scale-95";
            
            document.getElementById('timerDisplay').parentElement.classList.add('timer-active');

            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                if (timerSeconds <= 0) {
                    stopTimer();
                    playNotification();
                    alert("ğŸ”” æ™‚é–“åˆ°ï¼ä¼‘æ¯ä¸€ä¸‹æˆ–æ˜¯é–‹å§‹ä¸‹ä¸€æ®µæ—…ç¨‹ï¼");
                }
            }, 1000);
        }

        function stopTimer() {
            isTimerRunning = false;
            clearInterval(timerInterval);
            const btn = document.getElementById('startBtn');
            btn.innerHTML = '<i class="fas fa-play mr-1"></i> ç¹¼çºŒ';
            btn.className = "flex-grow py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200 active:scale-95";
            document.getElementById('timerDisplay').parentElement.classList.remove('timer-active');
            document.title = "ä¸ƒå¹´ç´šå¯’å‡æˆ°é¬¥è¨ˆç•«";
        }

        function resetTimer() {
            stopTimer();
            timerSeconds = 45 * 60;
            updateTimerDisplay();
        }

        function playNotification() {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("å¯’å‡æˆ°é¬¥è¨ˆç•«", { body: "æ™‚é–“åˆ°äº†ï¼è©²æ›å€‹å‹•ä½œå›‰ï¼" });
            }
        }

        // --- Export Logic ---
        function exportDailyReport() {
            const dayData = scheduleData[currentDate] || {};
            let report = `ã€ä¸ƒå¹´ç´šå¯’å‡æˆ°é¬¥è¨ˆç•« - æ—¥çµç®—å ±å‘Šã€‘\n`;
            report += `æ—¥æœŸ: ${currentDate}\n`;
            report += `----------------------------------------\n`;
            report += `ä»Šæ—¥æ ¸å¿ƒæŒ‡æ¨™ï¼šè²¬ä»»å¿ƒã€æ±ºå¿ƒã€ç´°å¿ƒã€è€å¿ƒã€è¦å¾‹\n\n`;
            
            let doneList = [];
            let todoList = [];

            const dateObj = new Date(currentDate);
            const dayOfWeek = dateObj.getDay();
            const isPlanA = [1, 3, 5].includes(dayOfWeek);

            baseSchedule.forEach((item, index) => {
                if (item.type === 'break') return;
                
                let title = item.title;
                if (item.dynamic) {
                    title = isPlanA ? "è‹±æ–‡ (å½±é›†/é›œèªŒ)" : "è‡ªç„¶ (Session 1)";
                }

                const key = `${index}_${item.time}`;
                const content = dayData[key]?.content || "(æœªå¡«å¯«)";
                const isDone = dayData[key]?.done;

                // Format: [X] 09:00 - Math: Content
                let statusMark = isDone ? "[v]" : "[ ]";
                let line = `${statusMark} ${item.time} | ${title}`;
                if (item.type === 'core') line += `\n    â””â”€ é€²åº¦: ${content}`;

                if (isDone) {
                    doneList.push(line);
                } else {
                    todoList.push(line);
                }
            });

            report += `ğŸ“Š å®Œæˆé …ç›® (${doneList.length}):\n`;
            if (doneList.length === 0) report += "   (å°šç„¡å®Œæˆé …ç›®ï¼ŒåŠ æ²¹ï¼)\n";
            else report += doneList.join('\n') + "\n";

            report += `\nğŸ“ å¾…åŠ å¼· / æœªå®Œæˆ (${todoList.length}):\n`;
            if (todoList.length === 0) report += "   (å¤ªå¼·äº†ï¼ä»Šæ—¥ä»»å‹™å…¨æ•¸Cleanï¼)\n";
            else report += todoList.join('\n') + "\n";
            
            report += `\n----------------------------------------\n`;
            report += `å®¶é•·ç°½å: ___________________\n`;
            report += `å­¸ç”Ÿè‡ªè©• (1-10åˆ†): __________\n`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¯’å‡è¨ˆç•«_æ—¥çµå–®_${currentDate}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>